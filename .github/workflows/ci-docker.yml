name: Docker CI - SportHack Store

on:
  pull_request:
    branches: [main]

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/cache@v3
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('backend/package-lock.json') }}

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install

      - name: Tar backend folder
        run: tar -czf backend.tar.gz backend

      - name: Setup upload artifact action
        uses: actions/upload-artifact@v3

      - name: Upload backend artifact
        uses: actions/upload-artifact@v3
        with:
          name: backend-artifact
          path: backend.tar.gz

  docker-compose-test:
    needs: build-backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Download backend artifact
        uses: actions/download-artifact@v3
        with:
          name: backend-artifact

      - name: Extract backend
        run: |
          tar -xzf backend.tar.gz

      - name: Docker Compose up
        run: docker-compose -f docker-compose.yml up --build -d

      - name: Wait for backend
        run: |
          echo "Waiting for backend..."
          until curl -s http://localhost:5001/healthcheck; do
            sleep 5
          done
          echo "Backend is ready!"

      - name: Run tests (optional)
        run: echo "Run your tests here..."

      - name: Shutdown
        if: always()
        run: docker-compose down -v
